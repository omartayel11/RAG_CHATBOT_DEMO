from langchain.chains import LLMChain
from langchain_core.prompts import ChatPromptTemplate, HumanMessagePromptTemplate, MessagesPlaceholder
from langchain_core.messages import SystemMessage
from langchain.chains.conversation.memory import ConversationBufferWindowMemory
from langchain_groq import ChatGroq
import chromadb
from chromadb.utils import embedding_functions
from groq import Groq
from datetime import datetime
import os



def retrieve_data(query):
    """
    Retrieves top matching recipes from ChromaDB and returns both titles and documents.
    """
    chroma_client = chromadb.HttpClient(host='localhost', port=8000)

    model_name = "akhooli/Arabic-SBERT-100K"
    sentence_transformer_ef = embedding_functions.SentenceTransformerEmbeddingFunction(model_name=model_name)

    try:
        collection = chroma_client.get_collection("recipestest", embedding_function=sentence_transformer_ef)
        print("Collection 'recipestest' found.")
    except chromadb.errors.InvalidCollectionException:
        print("Collection 'recipestest' does not exist. Please add data first.")
        return []

    results = collection.query(
        query_texts=[query],
        n_results=5,
        include=["documents", "metadatas"]  # Correct: include metadatas, not ids.
    )

    print("๐ Raw ChromaDB Results:", results)

    structured_results = []
    for doc, metadata in zip(results["documents"][0], results["metadatas"][0]):
        structured_results.append({
            "title": metadata.get("title", "ูุตูุฉ ุจุฏูู ุนููุงู"),
            "document": doc
        })


    return structured_results



def enhance_query_with_groq(query, chat_context=""):
    """
    This function uses the Groq API to enhance the query and determine if it's food-related.
    """
    client = Groq(api_key=os.getenv("GROQ_API_KEY"))
    system_prompt = """
ุฃูุช ูุฑุงูุจ ูุชุญููู ุงููุญุงุฏุซุฉ ุจูู ุงููุณุชุฎุฏู ูุงูุฑูุจูุชุ ููุฏูู ูู ุชุตููู ูู ูููู ุจุฏูุฉ ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุชูููุฐ ุงุณุชุฑุฌุงุน ููุตูุฉ ุทุนุงู.

 ูุฌุจ ุชุตููู ุงูุญุงูุฉ ุฅูู ูุงุญุฏุฉ ููุท ูู ุงููุฆุงุช ุงูุฃุฑุจุน ุงูุชุงููุฉ:

1. not food related  
2. respond based on chat history  
3. food generalized  
4. [ุงุณู ุงูุฃููุฉ ุฃู ููุน ุงูุทุนุงู]

---

 1. not food related  
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุนูุฏูุง ูููู ุงูุญุฏูุซ:
- ุงุฌุชูุงุนู ุฃู ุชุนุงุฑู ููุท
- ุฃู ุชุนุจูุฑ ุนู ุงูุฌูุน ุฃู ุงูุฑุบุจุฉ ุงูุนุงูุฉ ุจุงูุฃูู ุจุฏูู ููุฉ ุงูุทูุจ
- ุฃู ูุญุชูู ุนูู ุฐูุฑ ุทุนุงู ููุท ููุนูููุฉ ุดุฎุตูุฉ ุฃู ุฑุฃู ุจุฏูู ููุฉ ุงุณุชุฑุฌุงุน
- ุฃู ุนูุฏูุง ูุง ููุฌุฏ ุฃู ุฅุดุงุฑุฉ ูุงุถุญุฉ ุฅูู ููุฉ ุงูุญุตูู ุนูู ูุตูุฉ

 ููู: ุญุชู ูู ุฐููุฑ ุงููุณุชุฎุฏู ุงุณู ุฃููุฉุ ูุง ุชุฎุฑุฌูุง ุฅู ูู ููู ููุงู ุทูุจ ุตุฑูุญ ุฃู ููุงููุฉ ูุงุถุญุฉ.

**ุฃูุซูุฉ:**
- "ุฃูุง ุฌุนุงู"
- "ููุช ุจููุฑ ูู ุงูุฃูู"
- "ุจุญุจ ุดูุฑุจุฉ ุนุฏุณ"
- "ุงูุฃูู ุงููุตุฑู ูููุฒ"
- "ุงูุฃููุฉ ุฏู ุฐูุฑุชูู ุจุฃูุงู ุฒูุงู"
- "ุฃูุง ุจุญุจ ุงูุฃูู ุงููุจุงุชู"
- "ุฒูุงู ููุช ุจุงูู ูุดุฑู ูู ุฃุณุจูุน"
- "ุฃูุง ุดุจุนุงู ุจุณ ุจุญุจ ุงููููุฎูุฉ"
- "ุชุญุจ ูุญูู ุนู ุฃููุงุช ูู ุฒูุงูุ"
- "ุงูุฃูู ุนููููุง ูุฐูุฐ"

---

 2. respond based on chat history  
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุฅุฐุง ูุงู ุญุฏูุซ ุงููุณุชุฎุฏู ุชุนููููุง ุฃู ูุชุงุจุนุฉ ููุตูุฉ ุชู ุนุฑุถูุง ูุณุจููุง ูู ููุณ ุงูุฌูุณุฉุ ูุซู ุชุฌุฑุจุฉุ ุชุฃููุฏุ ุฃู ููุงููุฉ ูุชุฃุฎุฑุฉ.

**ุฃูุซูุฉ:**
- "ุฌุฑุจุชูุง ููุงูุช ููุชุงุฒุฉ"
- "ุขู ูุนูุงู ุทูุนุช ุญููุฉ"
- "ุงููู ูุงุชุช ูุงูุช ูุฐูุฐุฉ"
- "ูุฑุฌุน ูููุตูุฉ ุงููู ูุงุชุช"
- "ูุงุดู ูุนูู ุงููู ูุงุชุช ุชุงูู"
- "ุนุฌุจุชูู ุงููุตูุฉ ุงููู ูุงุชุช"
- "ูุง ุงูุง ุนุงูุฒ ุงููุตูู ุฏู ู ูููู ูุดูู ูููุง ุงูุจุตู"

ุชุฃูุฏ ูู ุงูุชุฑููุฒ ูู ูุฐู ุงูุญุงูู ุนูู ุงูุณูุงู ุงูุณุงุจูุ ููุง ุชุฎุฑุฌ ุฃู ุฃููุฉ ุฌุฏูุฏุฉ ุฃู ุงูุชุฑุงุญุงุช ุญูุซ ุงู ุงููุณุชุฎุฏู ูุชุญุฏุซ ุนู ูุตูุฉ ุชู ุงุณุชุฑุฌุงุนูุง ุจุงููุนู.

---

 3. food generalized  
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุนูุฏูุง ูุชุญุฏุซ ุงููุณุชุฎุฏู ุนู ููุน ุทุนุงู ุนุงู ุจุฏูู ุชุญุฏูุฏ ุงุณู ุฃููุฉุ ูุน ูุถูุญ ููุชู ูู ุงูุฃูู ุฃู ุงูุญุตูู ุนูู ุงูุชุฑุงุญุ ูููู ุฏูู ุฐูุฑ ุฃููุฉ ูุญุฏุฏุฉ ุจุนุฏ.

**ุฃูุซูุฉ:**
- "ุฃูุง ุนุงูุฒ ุดูุฑุจุฉ"
- "ููุณู ูู ุญุงุฌุฉ ูุจุงุชูุฉ"
- "ุฃูุง ุจููุฑ ูู ุฃูู ุจุญุฑู"
- "ุญุงุจุจ ุญุงุฌุฉ ุฎูููุฉ"
- "ุฃูุง ุญุงุจุจ ุฃููุฉ ูู ุงููุฑู"
- "ูููู ูุนูู ุญุงุฌุฉ ูุดููุฉุ"
- "ุฃูุง ูุงูู ูููุนุฌูุงุช"
- "ุฃูุง ุนุงูุฒ ุญุงุฌุฉ ุณุฎูุฉ"
- "ูููู ุฃูู ุนูู ุงูุณุฑูุนุ"
- "ุญุงุจุจ ุฃุจุฏุฃ ุจุญุงุฌุฉ ุฎูููุฉ"
- "ุฃูุง ุจููุฑ ูู ุตูู ุฎููู ูุด ุชููู"

 ููุงุญุธุฉ: ูู ูุฐู ุงูุญุงูุงุชุ ูุง ูุชู ุชูููุฐ ุงุณุชุฎุฑุงุฌ ุงุณู ุงููู ุจุนุฏ โ ุจู ููุชุฑู ุงููุฑุงุฑ ููุฑูุจูุช ููููุฏ ุงูุญูุงุฑ ูุญู ุชุญุฏูุฏ ุฃููุฉ ูุงุถุญุฉ.

---

 4. [ุงุณู ุงูุฃููุฉ ุฃู ููุน ุงูุทุนุงู]
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ููุท ุนูุฏูุง:
- ูุทูุจ ุงููุณุชุฎุฏู ุตุฑุงุญุฉ ุฃููุฉ ุฃู ูุตูุฉ ูุญุฏุฏุฉ
- ุฃู ููุงูู ุจูุถูุญ ุนูู ุงูุชุฑุงุญ ูุนูู ุชู ุชูุฏููู ูู ุงูุฑุณุงูุฉ ุงูุณุงุจูุฉ ูู ุงูุฑูุจูุช (ููู ูุชู ุนุฑุถู ุจุนุฏ)

 ูู ูุฐู ุงูุญุงูุฉุ ูุฌุจ ุฃู ุชุณุชุฎุฑุฌ ุงุณู ุงูุฃููุฉ ูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุฃู ูู ุงูุงูุชุฑุงุญ ุงูุณุงุจู ูู ุงูุฑูุจูุช.

 ูุง ุชุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุฅุฐุง ูู ุชูู ููุงู ููุฉ ูุงุถุญุฉ ูุทูุจ ุงููุตูุฉ ุฃู ููุงููุฉ ูุจุงุดุฑุฉ ุนูู ุงูุชุฑุงุญ.

**ููููุน ููุนูุง ุจุงุชูุง:**
ุงู ุชุฎูุท ุจูู ูุฐู ุงูุญุงูู ู ุญุงูุฉ ุงู ุงููุณุชุฎุฏู ูุชุญุฏุซ ุนุจ ูุตูุฉ ุชู ุงุณุชุฑุฌุงุนูุง ุจุงููุนู.

ุงุณุชุฎุฑุงุฌ ุงุณู ูุตูู ูุฌุจ ุงู ูููู ูุจูู ุนูู ูุฑุงุฑ ุงููุฏ ุงู ุงููุณุชุฎุฏู ูุฑูุฏ ูุตูู ุฌุฏูุฏู.
ุงุฐุง ูุงู ููุงู ุดู ูู ุฐููุ ูุง ุชุฎุฑุฌ ุงุณู ุงููุฉ ุงุจุฏุง!

**ุฃูุซูุฉ:**
- "ูุงุชูู ูุตูุฉ ุดูุฑุจุฉ ุนุฏุณ" โถ ุดูุฑุจุฉ ุนุฏุณ  
- "ุฃูุง ุนุงูุฒ ูุดุฑู" โถ ูุดุฑู  
- "ุฌุฑุจูู ุงููุณูุนุฉ" โถ ูุณูุนุฉ  
- "ูููู ูุตูุฉ ุทุงุฌู ุจุงููุฉุ" โถ ุทุงุฌู ุจุงููุฉ  
- "ููุณู ูู ุฃููุฉ ูููุง ุฌูุจุฑู" โถ ุฃููุฉ ูููุง ุฌูุจุฑู  
- ุงูุฑูุจูุช: "ุชุญุจ ุดูุฑุจุฉ ุงูุทูุงุทูุ"  
  ุงููุณุชุฎุฏู: "ุขู ุฌุฑุจูุง" โถ ุดูุฑุจุฉ ุงูุทูุงุทู  
- ุงูุฑูุจูุช: "ูููู ูุนูู ูุจุณุฉุ"  
  ุงููุณุชุฎุฏู: "ูุงุดู" โถ ูุจุณุฉ  
- ุงูุฑูุจูุช: "ุชุญุจ ุฃุนููู ุดูุด ุทุงูููุ"  
  ุงููุณุชุฎุฏู: "ุฃููู ุฌุฑุจ" โถ ุดูุด ุทุงููู  

---

 ุชุนูููุงุช ุฅุถุงููุฉ ููุชุนุงูู ูุน ุงูุญุงูุงุช ุงูุฎุงุตุฉ:

- ุฅุฐุง ุงุญุชูุช ุงูุฑุณุงูุฉ ุนูู ููุน ุทุนุงู ุนุงู ูุฃููุฉ ูุญุฏุฏุฉุ ูุชู ุงุฎุชูุงุฑ ุญุงูุฉ [ุงุณู ุงูุฃููุฉ] ููุท ุฅู ููุฌุฏุช ููุฉ ูุงุถุญุฉ ููุทูุจ ุฃู ุงูููุงููุฉ.
- ุงูุนุจุงุฑุงุช ูุซู "ููู ูุฃ"ุ "ูุงุดู ุฌุฑุจูุง"ุ "ุชูุงู ุงูุดู ุนูููุง" ุชูุนุชุจุฑ ููุงููุฉ ุตุฑูุญุฉ ุฅุฐุง ุฌุงุกุช ูุจุงุดุฑุฉ ุจุนุฏ ุงูุชุฑุงุญ ูู ุงูุฑูุจูุช.
- ุฅุฐุง ุฑูุถ ุงููุณุชุฎุฏู ุงูุงูุชุฑุงุญ (ูุซู: "ูุด ุนุงูุฒ ูุจุณุฉ") ูุง ูุชู ุชูููุฐ ุงูุงุณุชุฑุฌุงุน ููุฐุง ุงูุงูุชุฑุงุญ.
- ุฅุฐุง ูุงูู ุงููุณุชุฎุฏู ุนูู ุงูุชุฑุงุญ ุบูุฑ ูุญุฏุฏ (ูุซู: "ูููู ูุนูู ุฃููุฉุ" โ "ูุงุดู") ููุฐุง ูุง ููุนุชุจุฑ ููุงููุฉ ุนูู ููุน ุทุนุงู ูุนูู.
- ุงุฐุง ุงุญุชูุช ุงูุฑุณุงูู ุนูู ุทูุจ ูุทุงุฑ ุงู ุบุฏุง ุงู ุนุดุงุกุ ูุง ุชุฎุฑุฌ ุงุณู ุฃููู ูุญุฏุฏู, ุจู ุงุณุชุฎุฏู food generalized.

---

 ููููุน ููุนูุง ุจุงุชูุง:
- ูุง ุชุฎุฑุฌ ุงุณู ุฃููุฉ ุฅูุง ุฅุฐุง ููุฌุฏ ุทูุจ ุตุฑูุญ ุฃู ููุงููุฉ ุตุฑูุญุฉ ุนูู ุงูุชุฑุงุญ ูุญุฏุฏ.
- ูุง ุชุฎุชุฑุน ุฃููุฉ ุฃู ุชูุชุฑุถ ููุฉ ุบูุฑ ูุฐููุฑุฉ.
- ูุง ุชููููุ ูุง ุชุดุฑุญุ ูุง ุชูุณูุฑ.
- ูุง ุชุชูุงุนู โ ููุท ุตููู ุจุฏูุฉ ู ุฐูุงุก ุนุงูู.

---

 ุงููุฎุฑุฌุงุช ุงูููุจููุฉ ููุท:

- not food related  
- respond based on chat history  
- food generalized  
- [ุงุณู ุฃููุฉ ุฃู ููุน ุทุนุงู ุญูููู ูุฐููุฑ ุจูุถูุญ ููุท]
ุจุฏูู ุงู ุฒุฎุงุฑูุ ุนูุงูุงุช ุชุฑูููุ ุฃู ุชูุณูู ุฎุงุต ุงู ุดุฑุญ ุงู ุงุณุจุงุจ ุงู ุชุนูููุงุช 

"""

    full_input = f"""ุณูุงู ุงููุญุงุฏุซุฉ ุงูุณุงุจู:
        {chat_context}

        ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงููุฉ:
        {query}
        """
    print("Full Input to query enhancer/classifier:", full_input)
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": full_input},
    ]

    chat_completion = client.chat.completions.create(
        messages=messages,
        model="meta-llama/llama-4-maverick-17b-128e-instruct",  # Change to appropriate model for query enhancement
        temperature=0.0,
    )

    return chat_completion.choices[0].message.content



def choose_from_suggestions(suggestions_string: str) -> str:
    """
    Displays a list of Arabic food suggestions, prompts the user to choose one, and returns the selected option.
    """
    suggestions = [line.strip() for line in suggestions_string.strip().split('\n') if line.strip()]
    
    print("Please choose one of the following options:")
    for idx, suggestion in enumerate(suggestions, 1):
        print(f"{idx}. {suggestion}")
    
    selected_index = None
    while selected_index is None:
        try:
            choice = int(input("Enter the number of your choice: "))
            if 1 <= choice <= len(suggestions):
                selected_index = choice - 1
            else:
                print("Invalid choice. Please try again.")
        except ValueError:
            print("Please enter a valid number.")
    
    return suggestions[selected_index]

def select_suggestion_from_list(suggestions_string: str) -> list:
    """
    Takes a string of newline-separated suggestions and returns them as a list (without printing or prompting).
    """
    return [line.strip() for line in suggestions_string.strip().split('\n') if line.strip()]


class WebSocketBotSession:
    def __init__(self):
        self.memory = ConversationBufferWindowMemory(k=12, memory_key="chat_history", return_messages=True)
        self.expecting_choice = False
        self.suggestions = []
        self.original_question = ""
        self.user_name = None
        self.user_gender = None
        self.user_profession = None 
        self.mode = None
        self.retrieved_documents = {}  # Holds full recipes keyed by title
        self.last_user_query = None
        self.groq_api_key = os.getenv("GROQ_API_KEY")
        self.model = 'meta-llama/llama-4-maverick-17b-128e-instruct'
        self.groq_chat = ChatGroq(groq_api_key=self.groq_api_key, model_name=self.model)

    def set_user_info(self, name: str, gender: str, profession: str = None, likes: list = None, dislikes: list = None, allergies: list = None, favorite_recipes: list = None):
        self.user_name = name
        self.user_gender = gender
        self.user_profession = profession
        self.user_likes = likes or []
        self.user_dislikes = dislikes or []
        self.user_allergies = allergies or []
        self.user_favorite_recipes = favorite_recipes or []
        self._update_system_prompt()

    def set_mode(self, mode):
        self.mode = mode
        self._update_system_prompt()


    def get_recent_chat_context(self, n=10):
        history = self.memory.load_memory_variables({})["chat_history"]
        return "\n".join(
            f"{m.type}: {m.content}" for m in history[-n:]
        )

    def _update_system_prompt(self):
    
        if self.user_profession:
            profession = self.user_profession.strip().lower()
            if "ูููุฏุณ" in profession:
                title = "ุจุดูููุฏุณ" if self.user_gender == "male" else "ุจุดูููุฏุณู"
            elif "ุฏูุชูุฑ" in profession:
                title = "ุฏูุชูุฑ" if self.user_gender == "male" else "ุฏูุชูุฑู"
            else:
                title = self.user_profession
        else:
            title = "ุฃุณุชุงุฐ" if self.user_gender == "male" else "ุฃุณุชุงุฐุฉ"
        
        likes_str = "ุ ".join(self.user_likes) if self.user_likes else "ูุง ููุฌุฏ"
        dislikes_str = "ุ ".join(self.user_dislikes) if self.user_dislikes else "ูุง ููุฌุฏ"
        allergies_str = "ุ ".join(self.user_allergies) if self.user_allergies else "ูุง ููุฌุฏ"
        favorites_titles = [fav["title"] for fav in self.user_favorite_recipes] if self.user_favorite_recipes else []
        favorites_str = "ุ ".join(favorites_titles) if favorites_titles else "ูุง ููุฌุฏ"
        now = datetime.now()
        current_time = now.strftime("%H:%M")
        current_date = now.strftime("%Y-%m-%d")

        core_prompt = f"""

        ุฃูุช ุฑูุจูุช ุฏุฑุฏุดุฉ ุฐูู ููุฏูุฏ ููุฏูู ุญุณ ููุงูู ุฎูููุ ูุชูุชู ููุท ุจุงูุทุนุงู. ุชุชุญุฏุซ ุจุงููุงูู ุจุงููุบุฉ ุงูุนุฑุจูุฉุ ูุจุงูุชุญุฏูุฏ ุจุงูููุฌุฉ ุงููุตุฑูุฉ.
ุงููุณุชุฎุฏู ุงูุฐู ุชุชุญุฏุซ ูุนู ูู: {title} {self.user_name}.
ูุฌุจ ุฃู ุชูุงุฏูู ุจุดูู ุทุจูุนู ุจููุจู ุฃู ุจุงุณูู ูู ุจุฏุงูุฉ ุงููุญุงุฏุซุฉ ุฃู ูู ูุญุธุงุช ููุงุณุจุฉ ููุทุ ุฏูู ุงูุฅูุซุงุฑ ุฃู ุงูุชูุฑุงุฑ ุบูุฑ ุงูุทุจูุนู.
ุงููุณุชุฎุฏู {self.user_gender}.
ุญุงูุธ ุฏุงุฆูุง ุนูู ูุฎุงุทุจุฉ ุงููุณุชุฎุฏู ุญุณุจ ูู ุฐูุฑ ุงู ุงูุซู.
ูุฐุง ูู ููุฎุต ูุนูููุงุช ุงููุณุชุฎุฏู:
  "ุงูุฃููุงุช ุงูููุถูุฉ": {likes_str}
  "ุงูุฃููุงุช ุบูุฑ ุงูููุถูุฉ": {dislikes_str}
  "ุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉ": {allergies_str}
  "ุงููุตูุงุช ุงูููุถูู ูุฏู ุงููุณุชุฎุฏู ูู ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ": {favorites_str}
ูุฌุจ ุฃู ุชุฃุฎุฐ ูุฐู ุงููุนูููุงุช ูู ุงูุงุนุชุจุงุฑ ุนูุฏ ุงูุชุฑุงุญ ุงููุตูุงุช ุฃู ุงูุฃููุงุช ู ุนูุฏ ุงูุชูุงุนู ูุน ุงููุณุชุฎุฏู ู ูุฌุจ ุงู ูููู ุงุณุชุฎุฏุงููู ููุทูู.
.ูุฌุจ ุงูุชุดุฏูุฏ ุนูู ุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉุ ุญูุซ ูุฌุจ ุชุฌูุจ ุงู ุนุฑุถ ุจุฏุงุฆู ุฃู ููููุงุช ุฃู ุฃููุงุช ุชุญุชูู ุนูู ููููุงุช ุชุณุจุจ ุญุณุงุณูุฉ ูููุณุชุฎุฏู 

ุงููุญุงุฏุซุฉ ุงูุงู ูู: {self.mode}
ุงุฐุง ูุงูุช ุงููุญุงุฏุซุฉ voice :
 ุชุนูููุงุช ุฎุงุตุฉ ุจููุท ุงููุญุงุฏุซุฉ ุงูุตูุชูุฉ:

- ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุฑุฏูุฏ **ููุฌุฒุฉ ููุงุถุญุฉ ููุจุงุดุฑุฉ**.
- ูุง ุชุทุฑุญ ุฃูุซุฑ ูู ุณุคุงู ูู ููุณ ุงูุฑุณุงูุฉ.
- ุงุณุชุฎุฏู **ุงููุบุฉ ุงูุนุฑุจูุฉ ุจุงูุชุดููู ุงููุงูู** ูุชุณููู ุงููุทู ุนุจุฑ ูููุฐุฌ ุชุญููู ุงููุต ุฅูู ููุงู.
- ุฅุฐุง ุชู ุงุณุชุฑุฌุงุน ูุตูุฉุ **ูุง ุชูุนุฑุถ ุงููุตูุฉ ูุงููุฉ**ุ ุจู ูุฏู **ููุฎุตูุง ุจุณูุทูุง ุฌุฏูุง** ุนููุง ูู ุณุทุฑ ุฃู ุณุทุฑูู ููุท ููุถุญ ุงุณู ุงูุฃููุฉ ูุทุฑููุฉ ุงูุชุญุถูุฑ ุงูุนุงูุฉ.
- ุชูุฌููุจ ุงูุชูุงุตูู ุงูุทูููุฉ ุฃู ุงูููุงุฆู ุฃู ุงูุฎุทูุงุช ุงููุซูุฑุฉ ูู ุงูุฑุฏูุฏ.

ูุฏูู ูู ูุฐุง ุงูููุท ูู ุฃู ุชููู ุงูุฑุฏูุฏ ููุงุณุจุฉ ููุงุณุชูุงุน ุงูุณุฑูุนุ ุฏูู ุชุดููุด ุฃู ุชุนููุฏุ ูุจุทุฑููุฉ ุชุณููู ูุฑุงุกุชูุง ุตูุชููุง ูููุณุชุฎุฏู.


ูุนูููุฉ ุนู ุงูุฃููุงุจ:
ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูููุฏุณูุง (ูุซุงู: ูููุฏุณ ุฃู ูููุฏุณุฉ)ุ ูู ุงูุดุงุฆุน ูู ุงูููุฌุฉ ุงููุตุฑูุฉ ููุงุฏุงุชู ุจู "ุจุดูููุฏุณ" ุฃู "ูุง ููุฏุณุฉ" ุจุทุฑููุฉ ูุฏูุฏุฉ. 
ููููู ุงุณุชุฎุฏุงู "ุจุดูููุฏุณ {self.user_name}" ุฃู ููุท "ูุง ููุฏุณุฉ" ูู ุจุฏุงูุฉ ุงูุญุฏูุซ ุฃู ุนูุฏ ุงูุชุนูููุ ูููู ูุง ุชูุฑุท ูู ุงูุงุณุชุฎุฏุงู.
ููุณ ุงููุงุนุฏุฉ ุชูุทุจู ุนูู ุงูุฃุทุจุงุก ("ุฏูุชูุฑ" ุฃู "ูุง ุฏูุชูุฑ").

ููููุน ููุนุง ุจุงุชุง ุงูุงุฎุชูุงุท ูู ููุจ ุงู ููุน ุงููุณุชุฎุฏู.
ุงุณุชุฎุฏู ุงูุงููุงุช ุงูููุถูู ูุฏู ุงููุณุชุฎุฏู ูู ุงูุฑุงุญุงุชู ู ููู ูุง ุชุณุชุฎุฏููู ุชุญุฏูุฏุง ู ุงุณุชุฎุฏู ุงูููุนูุฉ ุงู ุงูุงููุงุช ุงููุดุงุจูุฉ ุจุดูู ุนุงู.


ูุฌุจ ุฃู ุชุณุชููุฏ ูู ุงูููุช ุงูุญุงูู ูู ุงููุญุงุฏุซุฉ ุนูุฏ ุชูุฏูู ุงูููุชุฑุญุงุชุ ู ุชุฐูุฑ ุฃู ุงูููุช ุงูุญุงูู ูู: {current_time}ุ ู ุงูุชุงุฑูุฎ ูู: {current_date}.
ุงุณุชุฎุฏุงู ุงูููุช ุงูุญุงูู ุณูุณุงุนุฏู ูู ุชูุฏูู ุงูุชุฑุงุญุงุช ููุงุฆูุฉ ูููุณุชุฎุฏูุ ูุซู ุงูุชุฑุงุญ ูุฌุจุงุช ุฎูููุฉ ุฃู ุฃููุงุช ุณุฑูุนุฉ ุฃู ุงูุฅูุทุงุฑ ุฃู ุงูุบุฏุงุก ุฃู ุงูุนุดุงุกุ ุญุณุจ ุงูููุช ุงูุญุงูู.

ุชุนูููุงุช ุฎุงุตุฉ ููุจุงุฑ ุงูุณู:
- ุชุญุฏุซ ุจูุจุฑุฉ ูุงุฏุฆุฉ ููุญุชุฑูุฉ ุฏุงุฆููุง.
- ูุง ุชุณุชุฎุฏู ูุบุฉ ุชูููุฉ ุฃู ูุตุทูุญุงุช ูุนูุฏุฉ.
- ุงุฌุนู ุงูุฑุฏูุฏ ูุตูุฑุฉ ููุจุงุดุฑุฉ ูุณููุฉ ุงูููู.
- ุฅุฐุง ุดุนุฑุช ุฃู ุงููุณุชุฎุฏู ุฃูุจุฑ ุณููุงุ ูู ุตุจูุฑูุง ูุฃุนุฏ ุงูุชูุถูุญ ุนูุฏ ุงูุญุงุฌุฉ.

ุนู ูุจุฑุฉ ุงูุตูุช:
- ุฅุฐุง ูุงูุช ุงููุจุฑุฉ ูุฏูุฏุฉุ ุชุฌุงูุจ ุจุญูุงุณ ูุฏูุก.
- ุฅุฐุง ูุงูุช ุงููุจุฑุฉ ุบุงุถุจุฉ ุฃู ููุฒุนุฌุฉุ ูุง ุชุนุชุฐุฑ ููุฑูุงุ ุจู ุญุงูู ุชุญููู ุงูุงููุนุงู ุฅูู ูุฒุงุญ ุฎููู ูุญุชุฑู.
  ูุซู: "ุดูู ุญุถุฑุชู ุฒุนูุงูุ ุจุณ ุฃุฑุงูู ุฅู ุงููุตูุฉ ุฏู ูุชุตููุญ ุงููุฒุงุฌ!"
  ุฃู: "ุทุจ ุงุฏููู ูุฑุตุฉ ุฃุซุจุชูู ุฅู ุงูููุถูุน ูุณุชุงูู... ูู ูุทูุนุชุด ูุฐูุฐุฉุ ุญูู ุนูููุง!"

ุนู ุงูุดุฎุตูุฉ:
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุญุงุฒููุงุ ูู ูุจุงุดุฑูุง ููุนุงููุง.
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุชุฑุฏุฏูุงุ ุงูุชุฑุญ ุจูุทู ูุงุฏุนูู ูู ุงุชุฎุงุฐ ุงููุฑุงุฑ.
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุญุจ ุงููุฒุงุญุ ุฑุฏ ุนููู ุจุฎูุฉ ุฏูุ ุฏูู ูุจุงูุบุฉ ุฃู ุชูุฑูุฌ.

ููููุน ุชูุงููุง:
- ูุง ุชุฎุชุฑุน ูุตูุงุช ุฃู ุชุชุญุฏุซ ุนู ูุตูุงุช ุบูุฑ ููุฌูุฏุฉ.
- ูุง ุชูุชุฑุถ ูุฌูุฏ ุตูู ุฅุฐุง ูู ูุชู ุงุณุชุฑุฌุงุนู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
- ูุง ุชูุฏู ุงูุชุฑุงุญุงุช ุนุงูุฉ ุนู ุงูุทุนุงู ุฅุฐุง ูู ูุชู ุทูุจูุง ุจูุถูุญ.
-
ููููุน ููุนูุง ุจุงุชูุง ุฐูุฑ ุฃุณูุงุก ูุตูุงุช ุฏูููุฉ ุฃู ูุญุฏุฏุฉ ูุซู ูุดุฑู ุจุงูุนุฏุณ ุฃู ุจูุชุฒุง ูุงุฑุฌุฑูุชุง ุฃู ูุงุฒุงููุง ุงูุณุจุงูุฎ ุฃู ุฃู ูุตูุฉ ุจุนูููุง. ูุฌุจ ุฃู ุชูุชุตุฑ ุงูุงูุชุฑุงุญุงุช ููุท ุนูู ุฃููุงุน ุนุงูุฉ ูู ุงูุฃุทุนูุฉ ุฃู ููููุงุชูุง ูุซู ุฏุฌุงุฌุ ูุญูุ ููุฑููุฉุ ุฃุฑุฒุ ุดูุฑุจุฉุ ุณูุทุงุชุ ูุฃูููุงุช ุจุญุฑูุฉุ ุฎุถุฑูุงุชุ ูุนุฌูุงุชุ ุญูููุงุชุ ูุดุฑูุจุงุชุ ุนุตุงุฆุฑุ ุฃู ุบูุฑูุง. ุนููู ุฃู ุชููู ูุจุฏุนูุง ูู ุงูุชุฑุงุญ ุฃููุงุน ุทุนุงู ุนุงูุฉ ุชูุงุณุจ ุณูุงู ุงููุญุงุฏุซุฉ ุจุฏูู ุงูุชููุฏ ุจุงูุฃูุซูุฉ ุงููุฐููุฑุฉ ููุงุ ูููู ุชุญุช ุฃู ุธุฑูุ ูุง ุชุฐูุฑ ูุตูุฉ ูุงููุฉ ุฃู ุงุณู ุฃููุฉ ูุญุฏุฏุฉ. ูุฌุจ ุฃู ุชุจูู ุงูุงูุชุฑุงุญุงุช ุนุงูุฉ ูุดุงููุฉ ูุถูุงู ุงูุชูุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนุฏู ุงูุชุฑุงุถ ูุฌูุฏ ูุตูุฉ ูุนููุฉ ุจุงูุงุณู. ุฅุฐุง ุดุนุฑุช ุฃู ุงููุณุชุฎุฏู ูุญุชุงุฌ ุฅูู ุงูุชุฑุงุญุ ุงุณุชุฎุฏู ูุตุทูุญุงุช ุนุงูุฉ ุฌุฏูุง ููุทุนุงูุ ูุน ุงูุญูุงุธ ุนูู ุฃุณููุจ ุทุจูุนู ููุฑู ููุงุณุจ ุณูุฑ ุงููุญุงุฏุซุฉ.
ุฅุฐุง ูู ุชุชุทุงุจู ุงููุตูุงุช ุงููุณุชุฑุฌุนุฉ ูุน ููุฉ ุงููุณุชุฎุฏูุ ุฃุฎุจุฑู ุจูุทุงูุฉ:
- ูุซููุง: "ุงูููุน ุฏู ูุด ููุฌูุฏ ุญุงูููุงุ ูููู ุชูุถุญ ุฃูุชุฑ ุชุญุจ ุชุงูู ุฅููุ"
- ุซู ูุฌูู ุงูุญุฏูุซ ุจุดูู ุทุจูุนู ุญุชู ูุนุจุฑ ุงููุณุชุฎุฏู ุนู ุทูุจ ูุงุถุญ ููุตูุฉ ุฃู ููุน ุฃูู.

ูุฏูู ุงูุฃุณุงุณู:
ุฃู ูุนุจุฑ ุงููุณุชุฎุฏู ุจูุถูุญ ุนู ูุตูุฉ ุฃู ููุน ุฃูู ูุฑูุฏูุ ูุชููู ุงูููุธููุฉ ุจุฌูุจ ุงููุตูุฉ ุงูุฏูููุฉ ูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

ููุงูู:
- ุงุจุฏุฃ ุงูุญุฏูุซ ุจููุจ ุงููุณุชุฎุฏู ุจุดูู ุทุจูุนู (ูู ุฃูู ุณุทุฑ ููุท ุฃู ุนูุฏ ุงูุญุงุฌุฉ).
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุดูุฆูุง ูุซู "ุฅุฒูู" ุฃู "ูุณุงุก ุงูุฎูุฑ"ุ ุฑุฏ ุนููู ุจูุทุงูุฉ ุจุฏูู ุงูุญุฏูุซ ุนู ุงูุฃูู.
- ูุง ุชูุชุฑุญ ูุตูุงุช ุจููุณู. ุงูุชุธุฑ ูุนุฒุฒ ุงูุงุณุชุนูุงู ููุญุฏุฏ ููุฉ ุงููุณุชุฎุฏู.
- ุฅุฐุง ุชู ุงุณุชุฑุฌุงุน ูุตูุฉุ ุงุนุฑุถูุง ููุฑุง ููุง ูู ุฏูู ุชุนุฏูู ุฃู ุชูุฎูุต ู ูุฌุจ ุนููู ุนุฑุถูุง ูุงููุฉ.
- ุงุนุฑุถ ุงููุตูู ุงููุณุชุฑุฌุนู ููุง ูู ุจุงูุชุดููู.
- ุงุญุฑุต ุนูู ูุฎุงุทุจุฉ ุงููุณุชุฎุฏู ุญุณุจ ููุนู (ุฐูุฑ ุงู ุงูุซู) ูู ุชุนูููุงุช ุงููุตูู

ุฅุฑุดุงุฏุงุช ุงูุณููู:
- ูุง ุชูุฑุฑ ุงุณู ุงููุณุชุฎุฏู ุฃู ููุจู ูุซูุฑูุง ูุฐุง ุงูุฑ ูุงู ุฌุฏุง
- ุงุณุชุฎุฏู ุงูุฃููุงุจ ุงูููุงุณุจุฉ ููุท ุนูุฏ ุงูุญุงุฌุฉ (ุจุดูููุฏุณุ ูุง ุฏูุชูุฑุ ูุง ุงุณุชุงุฐ...).
- ูุง ุชูุฑุฑ ููุณู ุฃู ุชุชุญุฏุซ ุจุฃุณููุจ ุฑูุจูุชู.
- ุฅุฐุง ูู ูููู ุงููุณุชุฎุฏู ุฃู ูุงู ุบุงูุถูุงุ ูุฌููู ุจูุทุงูุฉ ูุณุคุงูู ุนู ุงูุฃูู.

ุชุณูุณู ุงููุธุงู:
1. ุญููู ุงููุณุชุฎุฏู ุจุงุณูู ุฃู ููุจู ุจุทุฑููุฉ ุทุจูุนูุฉ.
2. ูุง ุชูุชุฑุญ ุทุนุงููุง ุฅูุง ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ูุตูุฉ ุฃู ููุน ุฃูู ุจูุถูุญ.
3. ุฅุฐุง ุธูุฑุช ุงูุชุฑุงุญุงุชุ ุงูุชุธุฑ ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู.
4. ุนูุฏูุง ุชูุณุชุฑุฌุน ูุตูุฉุ ุงุนุฑุถูุง ููุง ูู ุฏูู ุชุนุฏูู.
5. ุฅุฐุง ูู ุชูุฌุฏ ูุตูุฉ ููุงุณุจุฉุ ุงุทูุจ ูู ุงููุณุชุฎุฏู ุชูุถูุญ ุฑุบุจุชู.
6. ุงุณุชูุฑ ูู ุงูุญุฏูุซ ุจูุจุฑุฉ ุทุจูุนูุฉุ ุฎูููุฉุ ููุฏูุฉ.

ููุญูุธู ูุงูู ุฌุฏุง ุฌุฏุง
- ุงุนุฑุถ ุงููุตูู ุงููุณุชุฑุฌุนู ููุง ูู ุจุงูุชุดููู.
- ุชุนุงูู ูุน ุงููุณุชุฎู ุญุณุจ ููุนู (ุฐูุฑ ุงู ุงูุซู) ูู ุชุนูููุงุช ุงููุตูู
- ุงุฐุง ูุงูุช ุงููุตูุฉ ุงููุณุชุฑุฌุนู ููุชูุจู ุจุตูุบุฉ ุงููุคูุซ ูุฌุจ ุชุนุฏูููุง ูุชูุงุณุจ ุงููุณุชุฎุฏู ุงูุฐูุฑ.
- ุงุฐุง ูุงูุช ุงููุญุงุฏุซุฉ voice ูุฌุจ ุงู ุชููู ุงููุตูุฉ ูุฎุชุตุฑุฉ ุฌุฏุง ู ูู.
ุฅุฐุง ูุงูุช ุงููุญุงุฏุซุฉ ุตูุชูุฉ (voice mode)ุ ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุฑุฏูุฏ ุจุงูููุฌุฉ ุงููุตุฑูุฉุ ููุชูุจุฉ ุจุงูุนุฑุจูุฉ ูุน ุงูุชุดููู ุงููุงูู ุจุทุฑููุฉ ุชูุณุงุนูุฏ ุนูู ุงูููุทู ุงูุตูุญูุญ.

 ุงุณุชุฎุฏู ุงูุชุดููู ูุชูุถูุญ ุงูููุทูุ ุญุชู ูุฅู ูู ููู ุงูุชุดููู ููุตุญู ุฑุณูู.
 ุงูุชุฒู ุจุงูุชุดููู ูู ูู ุงููููุงุชุ ููุง ุชููุงู ุจุงูููุฌุฉ ุงููุตุฑูุฉ.
 ูุง ุชููุชุจ ุงูุฑุฏูุฏ ุจุฏูู ุชุดููู ุฃุจุฏูุง ูู ูุฐุง ุงูููุท.

ูุซุงู: "ุฅุฒููุงู ุฃููุฏูุฑ ุฃูุณุงุนูุฏููุ" ุฃู "ุทูุจ ุฎูุฏ ุงูููุตููุฉ ุฏู!"
- ูุฌุจ ุงู ูููู ุงุณุชุฎุฏุงู ุงูุงููุงุช ุงูููุถูู ูุฏู ุงููุณุชุฎุฏู ููุทูู ู ููุณ ุจุดูู ุนุดูุงุฆู ู ูููู ุงุณุชุฎุฏุงููู ุจุดูู ุนุงู ู ููุณ ุจุดูู ูุญุฏุฏ.
- ูุง ุชุฎูุท ุงุจุฏุง ุจูู ุงููุญุงุฏุซุฉ ุงู voice ู ุงููุญุงุฏุซุฉ ุงู text.
- ูุง ุชุฎูุท ุงุจุฏุง ูู ุงูุงููุงุจ ู ูุง ููุน ุงููุณุชุฎุฏู.

ูู ุนููููุงุ ุตุงุฏููุงุ ููุชุนุงูููุงุ ูุงููุฏู ุฏุงุฆููุง ุฃู ุชุณุงุนุฏ ุงููุณุชุฎุฏู ูู ุงุฎุชูุงุฑ ูุตูุฉ ุญููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
"""


        self.system_prompt = core_prompt.strip()

    async def handle_message(self, user_input: str):
        print(f"\n๐ก Received user message: {user_input}")
        self.original_question = user_input

        recent_context = self.get_recent_chat_context(n=10)
        query_result = enhance_query_with_groq(user_input, chat_context=recent_context)

        print(f"๐ง Query Enhancer Output:\n{query_result}\n")

        if query_result in ["not food related", "respond based on chat history","food generalized"]:
            print("๐ Passing message directly to LLM without retrieval.\n")
            return await self._generate_response(user_input, query_result)

        documents = retrieve_data(query_result)
        if not documents:
            print("โ๏ธ No documents found. Responding with fallback.")
            return await self._generate_response(user_input, "ูู ุฃุชููู ูู ุงูุนุซูุฑ ุนูู ูุตูุงุช ููุงุณุจุฉ.")

        self.suggestions = [doc["title"] for doc in documents] + ["โ ูุง ุฃุฑูุฏ ุฃู ูู ูุฐู ุงูุฎูุงุฑุงุช"]  # Use titles as suggestions
        self.retrieved_documents = {doc["title"]: doc["document"] for doc in documents}
        self.expecting_choice = True

        print("๐ Recipe Titles Found:")
        for i, title in enumerate(self.suggestions, 1):
            print(f"{i}. {title}")

        return {
            "type": "suggestions",
            "message": "ุงุฎุชุฑ ุฑูู ูู ุงูุงุฎุชูุงุฑุงุช ุงูุชุงููุฉ:",
            "suggestions": self.suggestions
        }

    async def handle_choice(self, choice_index: int):
        print(f"๐ User selected choice index: {choice_index}")
        # Check if user chose to skip suggestions
        if choice_index == len(self.suggestions) - 1:
            print("๐ซ User rejected all suggestions.")
            self.expecting_choice = False
            self.suggestions = []
            return await self._generate_response(self.original_question, "ูู ูุชู ุงุฎุชูุงุฑ ุฃู ูุตูุฉ. ููููู ุงูุชุญุฏุซ ุจุญุฑูุฉ ุงูุขู.")

        if 0 <= choice_index < len(self.suggestions):
            selected_title = self.suggestions[choice_index]
            print(f"โ Selected Recipe Title: {selected_title}")

            retrieved_data = self.retrieved_documents[selected_title]
            print(f"๐ฆ Retrieved Full Recipe:\n{retrieved_data}\n")

            self.expecting_choice = False
            self.suggestions = []  # ๐๏ธ ADD THIS to clear suggestions safely

            response = await self._generate_response(self.original_question, retrieved_data)
            response["selected_title"] = selected_title  # โ Good
            response["full_recipe"] = retrieved_data     # ๐๏ธ ADD THIS line to send the full recipe text

            return response

        else:
            print("โ Invalid choice index received.")
            return {
                "type": "error",
                "message": "ุงุฎุชูุงุฑ ุบูุฑ ุตุงูุญ. ุญุงูู ุฑูู ุชุงูู."
            }

    
    async def _generate_response(self, user_input: str, retrieved_data: str):
        prompt = ChatPromptTemplate.from_messages([
            SystemMessage(content=self.system_prompt),
            MessagesPlaceholder(variable_name="chat_history"),
            HumanMessagePromptTemplate.from_template("{human_input}"),
        ])

        chat_history = self.memory.load_memory_variables({})["chat_history"]
        print(f"๐ Chat History Size: {len(chat_history)}")

        full_prompt = prompt.format_messages(
            chat_history=chat_history,
            human_input=user_input
        )

        print("๐ง Prompt Sent to LLM:")
        print(full_prompt)

        conversation_input = f"Retrieved Data: {retrieved_data}\nUser Question: {user_input}"

        conversation = LLMChain(
            llm=self.groq_chat,
            prompt=prompt,
            verbose=False,
            memory=self.memory,
        )

        response = conversation.predict(human_input=conversation_input)

        print("๐ฌ Chatbot Response:\n", response)
        return {
            "type": "response",
            "message": response
        }

